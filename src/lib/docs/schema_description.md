# Database Schema Description

## Table: public.user_profiles
user_id: uuid (Primary Key, Supabase Auth ID)
username: character varying(255) (Unique)
email: character varying(255) (Unique)
first_name: character varying(255) (Nullable)
last_name: character varying(255) (Nullable)
profile_picture: text (Nullable)
bio: text (Nullable)
created_at: timestamp with time zone
updated_at: timestamp with time zone

## Table: public.mindmaps
mindmap_id: integer (Primary Key, Identity, Auto-increment)
user_id: uuid (Foreign Key -> user_profiles.user_id)
name: character varying(255)
description: text
created_at: timestamp with time zone
updated_at: timestamp with time zone

## Table: public.mindmap_nodes
node_id: integer (Primary Key, Identity, Auto-increment)
mindmap_id: integer (Foreign Key -> mindmaps.mindmap_id)
parent_node_id: integer (Foreign Key -> mindmap_nodes.node_id, Nullable)
content: text
x: double precision
y: double precision
z: double precision
node_type: character varying(50) -- 'concept' (for center nodes) or 'note' (for child nodes)
created_at: timestamp with time zone
title: varchar(255)
description: text

### Constraints:
- valid_parent: Ensures that:
  1. Center nodes (node_type = 'concept') must have parent_node_id = NULL
  2. Child nodes (node_type = 'note') must have a non-NULL parent_node_id
  3. No node can reference itself as parent (parent_node_id != node_id)

### Node Types:
- 'concept': Used for center/root nodes only. Must have null parent_node_id.
- 'note': Used for all child nodes. Must have a valid parent_node_id.

### Relationships:
- mindmap_id references public.mindmaps(mindmap_id) ON DELETE CASCADE
- parent_node_id references public.mindmap_nodes(node_id) ON DELETE CASCADE
- Self-referential relationship through parent_node_id

### Usage Notes:
- Each mindmap must have exactly one center node (node_type = 'concept')
- All other nodes must be of type 'note' and connected to either the center node or another note
- The hierarchical structure is maintained through the parent_node_id relationship
- Deleting a parent node will cascade to all child nodes

## Table: public.toit_sessions
session_id: integer (Primary Key, Identity, Auto-increment)
user_id: uuid (Foreign Key -> user_profiles.user_id)
name: character varying(255)
start_time: timestamp with time zone
end_time: timestamp with time zone (Nullable)
status: character varying(50) -- 'planned', 'in_progress', 'completed'
created_at: timestamp with time zone

## Table: public.toit_tasks
task_id: integer (Primary Key, Identity, Auto-increment)
session_id: integer (Foreign Key -> toit_sessions.session_id)
mindmap_node_id: integer (Foreign Key -> mindmap_nodes.node_id, Nullable)
name: character varying(255)
description: text
duration_minutes: integer
position_in_circle: integer -- For circular arrangement
status: character varying(50) -- 'pending', 'in_progress', 'completed'
created_at: timestamp with time zone

## Relationships
- public.mindmap_nodes.mindmap_id references public.mindmaps.mindmap_id (CASCADE)
- public.toit_tasks.session_id references public.toit_sessions.session_id (CASCADE)
- public.toit_tasks.mindmap_node_id references public.mindmap_nodes.node_id (SET NULL)
- public.mindmaps.user_id references public.user_profiles.user_id (CASCADE)
- public.toit_sessions.user_id references public.user_profiles.user_id (CASCADE)

## Notes
- All tables have Row Level Security (RLS) enabled
- Identity columns start at 1 and increment by 1
- Timestamps use timezone information
- Foreign keys have appropriate deletion behaviors (CASCADE or SET NULL)
- Appropriate indexes are created for foreign keys and common queries
- User IDs are UUIDs from Supabase auth.users table

# Current Schema
```sql
-- First, drop existing tables if they exist (in correct order due to dependencies)
DROP TABLE IF EXISTS public.toit_tasks CASCADE;
DROP TABLE IF EXISTS public.toit_sessions CASCADE;
DROP TABLE IF EXISTS public.mindmap_nodes CASCADE;
DROP TABLE IF EXISTS public.mindmaps CASCADE;
DROP TABLE IF EXISTS public.user_profiles CASCADE;

-- Create user profiles table (renamed from users)
CREATE TABLE public.user_profiles (
    user_id uuid PRIMARY KEY REFERENCES auth.users(id),
    username varchar(255) UNIQUE NOT NULL,
    email varchar(255) UNIQUE NOT NULL,
    first_name varchar(255),
    last_name varchar(255),
    profile_picture text,
    bio text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

-- Create mindmaps table
CREATE TABLE public.mindmaps (
    mindmap_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid REFERENCES public.user_profiles(user_id) ON DELETE CASCADE,
    name varchar(255) NOT NULL,
    description text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

-- Create mindmap_nodes table
CREATE TABLE public.mindmap_nodes (
    node_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    mindmap_id integer REFERENCES public.mindmaps(mindmap_id) ON DELETE CASCADE,
    parent_node_id integer REFERENCES public.mindmap_nodes(node_id) ON DELETE CASCADE,
    content text NOT NULL,
    x double precision NOT NULL,
    y double precision NOT NULL,
    z double precision NOT NULL,
    node_type varchar(50) CHECK (node_type IN ('concept', 'note')),
    created_at timestamp with time zone DEFAULT now(),
    title varchar(255),
    description text,
    CONSTRAINT valid_parent CHECK (
        (parent_node_id IS NULL AND node_type = 'concept') OR 
        (parent_node_id IS NOT NULL AND node_type = 'note' AND node_id != parent_node_id)
    )
);

-- Add index for parent-child relationship queries
CREATE INDEX idx_mindmap_nodes_parent_child ON public.mindmap_nodes(parent_node_id, node_id);

-- Create toit_sessions table
CREATE TABLE public.toit_sessions (
    session_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid REFERENCES public.user_profiles(user_id) ON DELETE CASCADE,
    name varchar(255) NOT NULL,
    start_time timestamp with time zone NOT NULL,
    end_time timestamp with time zone,
    status varchar(50) CHECK (status IN ('planned', 'in_progress', 'completed')),
    created_at timestamp with time zone DEFAULT now()
);

-- Create toit_tasks table
CREATE TABLE public.toit_tasks (
    task_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    session_id integer REFERENCES public.toit_sessions(session_id) ON DELETE CASCADE,
    mindmap_node_id integer REFERENCES public.mindmap_nodes(node_id) ON DELETE SET NULL,
    name varchar(255) NOT NULL,
    description text,
    duration_minutes integer NOT NULL,
    position_in_circle integer,
    status varchar(50) CHECK (status IN ('pending', 'in_progress', 'completed')),
    created_at timestamp with time zone DEFAULT now()
);

-- Add indexes for better query performance
CREATE INDEX idx_mindmap_nodes_mindmap_id ON public.mindmap_nodes(mindmap_id);
CREATE INDEX idx_mindmap_nodes_parent_id ON public.mindmap_nodes(parent_node_id);
CREATE INDEX idx_toit_tasks_session_id ON public.toit_tasks(session_id);
CREATE INDEX idx_toit_tasks_mindmap_node_id ON public.toit_tasks(mindmap_node_id);

-- Add RLS (Row Level Security) policies
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.mindmaps ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.mindmap_nodes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.toit_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.toit_tasks ENABLE ROW LEVEL SECURITY;

-- Create policies for user_profiles
CREATE POLICY "Users can view their own profile"
    ON public.user_profiles FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can update their own profile"
    ON public.user_profiles FOR UPDATE
    USING (auth.uid() = user_id);

-- Create policies for mindmaps
CREATE POLICY "Users can CRUD their own mindmaps"
    ON public.mindmaps FOR ALL
    USING (auth.uid() = user_id);

-- Create policies for mindmap_nodes
CREATE POLICY "Users can CRUD nodes in their mindmaps"
    ON public.mindmap_nodes FOR ALL
    USING (EXISTS (
        SELECT 1 FROM public.mindmaps
        WHERE mindmaps.mindmap_id = mindmap_nodes.mindmap_id
        AND mindmaps.user_id = auth.uid()
    ));

-- Create policies for toit_sessions
CREATE POLICY "Users can CRUD their own sessions"
    ON public.toit_sessions FOR ALL
    USING (auth.uid() = user_id);

-- Create policies for toit_tasks
CREATE POLICY "Users can CRUD tasks in their sessions"
    ON public.toit_tasks FOR ALL
    USING (EXISTS (
        SELECT 1 FROM public.toit_sessions
        WHERE toit_sessions.session_id = toit_tasks.session_id
        AND toit_sessions.user_id = auth.uid()
    ));
```

# End of Schema
